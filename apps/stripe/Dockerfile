# Build stage
FROM node:22-alpine AS builder

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@10.6.3

# Copy workspace config
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json ./

# Copy all packages (shared libs)
COPY packages ./packages

# Copy stripe app
COPY apps/stripe ./apps/stripe

COPY .env.docker .env
COPY .env.docker ./apps/stripe/.env

# Install dependencies
RUN pnpm install --frozen-lockfile
RUN pnpm run lint 
# Generate GraphQL types
WORKDIR /app/apps/stripe
RUN pnpm generate:app-graphql-types 
# RUN pnpm install
RUN pnpm run build 

# Check what's in the path
# RUN ls -la  

# Runtime stage
FROM node:22-alpine AS runner

# # Set environment for the app
# ENV NODE_ENV=production

# # Set the working directory
# WORKDIR /app

# # 1. è¤‡è£½æ ¸å¿ƒ Next.js é‹è¡Œç’°å¢ƒæ‰€éœ€çš„æ–‡ä»¶å’Œ pnpm
# # Next.js Server / Build output
# COPY --from=builder /app/apps/stripe/.next ./.next
# COPY --from=builder /app/apps/stripe/public ./public 

# # 2. è¤‡è£½ä¾è³´ (åªéœ€è¦ç”Ÿç”¢ç’°å¢ƒçš„ä¾è³´)
# # é€éŽ pnpm pruneï¼Œåªä¿ç•™ç”Ÿç”¢ç’°å¢ƒæ‰€éœ€ä¾è³´
# RUN npm install -g pnpm@10.6.3 # åœ¨ runner éšŽæ®µå®‰è£ pnpm
# COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
# COPY --from=builder /app/package.json ./package.json
# COPY --from=builder /app/node_modules ./node_modules
# # è¤‡è£½ Apps å’Œ Packages (å¦‚æžœå®ƒå€‘æœ‰é¡å¤–çš„é‹è¡Œæ™‚ä¾è³´æˆ–é‚è¼¯)
# COPY --from=builder /app/packages ./packages
# COPY --from=builder /app/apps/stripe ./apps/stripe

# # 3. (å¯é¸ï¼Œä½†å»ºè­°) åˆªé™¤é–‹ç™¼ä¾è³´
# RUN pnpm prune --prod

# ===============================================
# ðŸš€ Standalone å„ªåŒ–ï¼šä¸å†è¤‡è£½ package.json, pnpm-lock, node_modules
# ä¹Ÿä¸å†åŸ·è¡Œ pnpm prune
# ===============================================
WORKDIR /app

# 1. è¤‡è£½ Standalone æ¨¡å¼è¼¸å‡ºçš„æ‰€æœ‰å…§å®¹ (åŒ…å« server.js å’Œæ‰€æœ‰ Node ä¾è³´)
# è·¯å¾‘çµæ§‹ï¼š/app/apps/stripe/.next/standalone -> å®¹å™¨çš„ /app/
COPY --from=builder /app/apps/stripe/.next/standalone ./

# 2. è¤‡è£½ public æª”æ¡ˆ (éœæ…‹è³‡æº)
# è·¯å¾‘çµæ§‹ï¼š/app/apps/stripe/public -> å®¹å™¨çš„ /app/public
COPY --from=builder /app/apps/stripe/public ./public 

# Set environment
ENV NODE_ENV=production
# ðŸ’¡ ä¿®æ­£ 1: è¨­å®š PORT ç‚º 3001ï¼Œå¼·åˆ¶ Next.js æœå‹™å™¨åœ¨é€™å€‹ç«¯å£é‹è¡Œ
ENV PORT=3001
# ðŸ’¡ ä¿®æ­£ 2: è¨­å®š HOSTNAME è®“æœå‹™å™¨ç¶å®šåˆ°æ‰€æœ‰æŽ¥å£ (0.0.0.0)ï¼Œä»¥ä¾¿ Docker æ˜ å°„å­˜å–
ENV HOSTNAME=0.0.0.0

# Expose port
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# Start the app
# CMD ["pnpm", "start", "-p", "3001"]
CMD ["node", "apps/stripe/server.js", "-p", "3001"]