# Build stage
FROM node:22-alpine AS builder

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm@10.6.3

# Copy workspace config
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json ./

# Copy all packages (shared libs)
COPY packages ./packages

# Copy stripe app
COPY apps/stripe ./apps/stripe

COPY .env.docker .env
COPY .env.docker ./apps/stripe/.env

# Install dependencies
RUN pnpm install --frozen-lockfile
RUN pnpm run lint 
# Generate GraphQL types
WORKDIR /app/apps/stripe
RUN pnpm generate:app-graphql-types 
# RUN pnpm install
RUN pnpm run build 

# Check what's in the path
# RUN ls -la  

# Runtime stage
FROM node:22-alpine AS runner

# # Set environment for the app
# ENV NODE_ENV=production

# # Set the working directory
# WORKDIR /app

# # 1. è¤‡è£½æ ¸å¿ƒ Next.js é‹è¡Œç’°å¢ƒæ‰€éœ€çš„æ–‡ä»¶å’Œ pnpm
# # Next.js Server / Build output
# COPY --from=builder /app/apps/stripe/.next ./.next
# COPY --from=builder /app/apps/stripe/public ./public 

# # 2. è¤‡è£½ä¾è³´ (åªéœ€è¦ç”Ÿç”¢ç’°å¢ƒçš„ä¾è³´)
# # é€éŽ pnpm pruneï¼Œåªä¿ç•™ç”Ÿç”¢ç’°å¢ƒæ‰€éœ€ä¾è³´
# RUN npm install -g pnpm@10.6.3 # åœ¨ runner éšŽæ®µå®‰è£ pnpm
# COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
# COPY --from=builder /app/package.json ./package.json
# COPY --from=builder /app/node_modules ./node_modules
# # è¤‡è£½ Apps å’Œ Packages (å¦‚æžœå®ƒå€‘æœ‰é¡å¤–çš„é‹è¡Œæ™‚ä¾è³´æˆ–é‚è¼¯)
# COPY --from=builder /app/packages ./packages
# COPY --from=builder /app/apps/stripe ./apps/stripe

# # 3. (å¯é¸ï¼Œä½†å»ºè­°) åˆªé™¤é–‹ç™¼ä¾è³´
# RUN pnpm prune --prod

# ===============================================
# ðŸš€ Standalone æœ€çµ‚å„ªåŒ– (Monorepo-Safe Launch)
# å°‡å·¥ä½œç›®éŒ„è¨­å®šç‚ºæ‡‰ç”¨ç¨‹å¼æ ¹ç›®éŒ„ï¼Œç¢ºä¿ server.js èƒ½æ‰¾åˆ°æ‰€æœ‰ç›¸å°è·¯å¾‘çš„æ§‹å»ºè³‡æº
# ===============================================

# ðŸŽ¯ è¨­å®šå·¥ä½œç›®éŒ„åˆ°æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ (èˆ‡ build æ™‚ç›¸åŒ)
WORKDIR /app/apps/stripe

# 1. è¤‡è£½ Standalone æ¨¡å¼è¼¸å‡ºçš„æ‰€æœ‰å…§å®¹ (åŒ…å« server.js å’Œä¾è³´)
# ðŸŽ¯ é—œéµ: è¤‡è£½åˆ° /app/apps/stripe/
COPY --from=builder /app/apps/stripe/.next/standalone ./

# 2. è¤‡è£½ public æª”æ¡ˆ (éœæ…‹è³‡æº)
# è·¯å¾‘çµæ§‹ï¼š/app/apps/stripe/public -> å®¹å™¨çš„ /app/apps/stripe/public
COPY --from=builder /app/apps/stripe/public ./public 

# Set environment
ENV NODE_ENV=production
ENV PORT=3001
ENV HOSTNAME=0.0.0.0

EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001/', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# Start the app
# CMD ["pnpm", "start", "-p", "3001"]
CMD ["node", "apps/stripe/server.js", "-p", "3001"]